<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PATAPING</title>
    <style>
      :root{
        --bg: #ffffff;
        --fg: #0f172a;
        --muted: #6b7280;
        --up: #16a34a;
        --down: #dc2626;
        --error: #6b7280;
        --card-bg: rgba(0,0,0,0.02);
        --shadow: rgba(0,0,0,0.3);
      }
      @media (prefers-color-scheme: dark){
        :root{
          --bg: #0b1220;
          --fg: #e6eef8;
          --muted: #9aa6b2;
          --up: #22c55e;
          --down: #fb7185;
          --error: #94a3b8;
          --card-bg: rgba(255,255,255,0.03);
          --shadow: rgba(255,255,255,0.2);
        }
      }

      [data-theme="dark"]{
        --bg: #0b1220;
        --fg: #e6eef8;
        --muted: #9aa6b2;
        --up: #22c55e;
        --down: #fb7185;
        --error: #94a3b8;
        --card-bg: rgba(255,255,255,0.03);
        --shadow: rgba(255,255,255,0.2);
      }
      [data-theme="light"]{
        --bg: #ffffff;
        --fg: #0f172a;
        --muted: #6b7280;
        --up: #16a34a;
        --down: #dc2626;
        --error: #6b7280;
        --card-bg: rgba(0,0,0,0.02);
        --shadow: rgba(0,0,0,0.3);
      }

      body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 3rem; background: var(--bg); color: var(--fg); display: flex; flex-direction: column; align-items: center;}
      .box { position: relative; gap:1rem; border-color: var(--muted); border-radius: 1rem; border-style: solid; border-width: 0.0625rem; box-shadow: var(--shadow) 0 0 0.625rem;}
    .box { position: relative; gap:1rem; border-color: var(--muted); border-radius: 1rem; border-style: solid; border-width: 0.0625rem; padding: 1rem; width: min(45rem, calc(100% - 3rem)); box-sizing: border-box; }
      .container {display: flex; flex-direction: column; align-items: center;}
      .host { display:flex; align-items:center; align-content: center; gap:0.75rem; padding:0.5rem 0; width: 45rem; max-width: calc(100% - 3rem); }
      .label { padding:0.375rem 0.5rem; border-radius:0.375rem; color:white; font-weight:600; display:inline-block; min-width:2rem; text-align:center; max-width: fit-content;  }
      /* host row: two columns
        - .label-col : fixed width column that right-aligns the status label
        - .content : flexible column that left-aligns the host/name and meta info
      */
      .label-col { width: 11.25rem; /* adjust as needed */ display:flex; justify-content:flex-end; }
      .content { flex:1; text-align:left; background: var(--card-bg); padding:0.5rem 0.75rem; border-radius:0.375rem; }
        .theme-toggle { position: absolute; top: 0.75rem; right: 0.75rem; z-index: 10; background: transparent; border: 0.0625rem solid rgba(0,0,0,0.06); color: var(--fg); padding:0.375rem 0.625rem; border-radius:0.5rem; cursor:pointer; }
        [data-theme="dark"] .theme-toggle { border-color: rgba(255,255,255,0.06); }

        /* Responsive tweaks for small screens / phones */
        @media (max-width: 48.75rem) {
          body { padding: 1rem; }
          .box { padding: 0.75rem; width: calc(100% - 1.5rem); border-radius: 0.75rem; }
          .theme-toggle { top: 0.5rem; right: 0.5rem; padding:0.5rem; }
          .container { align-items: stretch; }
          /* keep label and hostname inline while allowing wrapping
             - use flex-wrap so label and content sit on same row when possible
             - allow content to shrink/wrap below when space runs out
          */
          .host { display:flex; flex-wrap:wrap; align-items:center; gap:0.5rem; padding:0.375rem 0; width:100%; max-width:100%; }
          .label-col { width: auto; display:flex; justify-content:flex-start; }
          .label { min-width: unset; text-align: left; padding:0.375rem 0.5rem; margin-right:0.5rem; }
          .content { padding:0.5rem; flex:1 1 auto; min-width:0; }
          .content strong { display:inline; }
          .meta { font-size:0.75rem; }
          h1 { font-size:1.25rem; margin:0 0 0.5rem 0; }
        }
      .up { background: var(--up); }
      .down { background: var(--down); }
      .error { background: var(--error); }
      .meta { color:var(--muted); font-size:0.8rem; }

      /* theme toggle button */
  .theme-toggle { position: absolute; top: 0.75rem; right: 0.75rem; z-index: 10; background: transparent; border: 0.0625rem solid rgba(0,0,0,0.06); color: var(--fg); padding:0.375rem 0.625rem; border-radius:0.5rem; cursor:pointer; }
  [data-theme="dark"] .theme-toggle { border-color: rgba(255,255,255,0.06); }
    </style>
  </head>
  <body>
    <div class="box">
    <button id="themeToggle" class="theme-toggle" aria-pressed="false">ðŸŒ“</button>
    <div class="container">
        <h1>PATAPING</h1>
        <p class="meta">Auto-refresh every 30s. Hosts are read from <code>hosts.txt</code> in the <a href="https://github.com/rsreds/pataping" style="color: var(--down); text-decoration: underline;">repository</a>.</p>
        <div id="last"></div>
        <div id="list"></div>
        <p class="meta">In case of issues, please write in the <a href="https://mattermost.web.cern.ch/patatrack/channels/town-square" style="color: var(--down); text-decoration: underline;">patatrack</a> mattermost channel</p>
    </div>
    </div>
    <script>
      // Theme handling: respect saved choice, otherwise follow prefers-color-scheme
      const THEME_KEY = 'pataping:theme';
      function applyTheme(t){
        if(t){
          document.documentElement.setAttribute('data-theme', t);
          document.getElementById('themeToggle').setAttribute('aria-pressed', t === 'dark');
          document.getElementById('themeToggle').textContent = t === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
        } else {
          document.documentElement.removeAttribute('data-theme');
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.getElementById('themeToggle').setAttribute('aria-pressed', prefersDark);
          document.getElementById('themeToggle').textContent = prefersDark ? 'ðŸŒ™' : 'â˜€ï¸';
        }
      }
      function initTheme(){
        const saved = localStorage.getItem(THEME_KEY);
        if(saved === 'dark' || saved === 'light'){
          applyTheme(saved);
        } else {
          applyTheme(null);
        }
      }
      function toggleTheme(){
        const cur = document.documentElement.getAttribute('data-theme');
        if(cur === 'dark'){
          localStorage.setItem(THEME_KEY, 'light');
          applyTheme('light');
        } else if(cur === 'light'){
          localStorage.setItem(THEME_KEY, 'dark');
          applyTheme('dark');
        } else {
          // no explicit theme -> flip based on prefers
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          const next = prefersDark ? 'light' : 'dark';
          localStorage.setItem(THEME_KEY, next);
          applyTheme(next);
        }
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        const tbtn = document.getElementById('themeToggle');
        initTheme();
        tbtn.addEventListener('click', toggleTheme);
      });

      async function fetchStatus(){
        try{
          const res = await fetch('/api/status');
          const data = await res.json();
        const lastEl = document.getElementById('last');
        const raw = data.checked_at;
        if (raw) {
            const dt = new Date(raw);
            if (!isNaN(dt)) {
                const pad = n => String(n).padStart(2, '0');
                const day = pad(dt.getDate());
                const month = pad(dt.getMonth() + 1);
                const year = dt.getFullYear();
                const hrs = pad(dt.getHours());
                const mins = pad(dt.getMinutes());
                const secs = pad(dt.getSeconds());
                // if date is not today, show date too
                const today = new Date();
                if (dt.toDateString() !== today.toDateString()) {
                    lastEl.textContent = 'Last update ' + `${day}/${month}/${year} ${hrs}:${mins}:${secs} `;
                } else {
                    lastEl.textContent = 'Last update ' + `${hrs}:${mins}:${secs} `;
                }
            } else {
                lastEl.textContent = 'Last update ' + raw;
            }
        } else {
            lastEl.textContent = 'Last update n/a';
        }

          const list = document.getElementById('list');
          list.innerHTML = '';
          (data.results || []).forEach(r => {
            const el = document.createElement('div');
            el.className = 'host';

              const labelCol = document.createElement('div');
              labelCol.className = 'label-col';
              const label = document.createElement('div');
              label.className = 'label ' + (r.status === 'up' ? 'up' : (r.status === 'down' ? 'down' : 'error'));
              label.textContent = r.status.toUpperCase();

              const txt = document.createElement('div');
              txt.className = 'content';
              // show name in bold if provided, otherwise show host in bold
              const displayName = r.name ? r.name : r.host;
              const hostPart = r.name ? ` <span class="meta">${r.host}</span>` : '';
              txt.innerHTML = `<strong>${displayName}</strong>${hostPart}` + (r.latency_ms ? ` &nbsp; <span class="meta">${r.latency_ms} ms</span>` : '');

              labelCol.appendChild(label);
              el.appendChild(labelCol);
              el.appendChild(txt);
            list.appendChild(el);
          });
        }catch(e){
          document.getElementById('list').textContent = 'Error fetching status: ' + e;
        }
      }

      fetchStatus();
      setInterval(fetchStatus, 30000);
    </script>
  </body>
</html>
